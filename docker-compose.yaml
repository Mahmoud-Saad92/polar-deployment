services:
  postgres:
    container_name: polar-postgres
    image: bitnami/postgresql:15.0.0
    env_file:
      - ./.env
    user: "1001:0"
    environment:
      POSTGRES_USER: ${POLAR_POSTGRES_USER}
      POSTGRES_PASSWORD: ${POLAR_POSTGRES_PASSWORD}
      POSTGRES_DB: 'polar_db'
      POSTGRESQL_SHARED_BUFFERS: 128MB
      POSTGRESQL_MAX_CONNECTIONS: 50
      POSTGRESQL_EFFECTIVE_CACHE_SIZE: 512MB
      POSTGRESQL_WORK_MEM: 8MB
      POSTGRESQL_MAINTENANCE_WORK_MEM: 64MB
      POSTGRESQL_LOG_CONNECTIONS: 'yes'
      POSTGRESQL_LOG_DISCONNECTIONS: 'yes'
      POSTGRESQL_LOG_STATEMENT: 'mod'                    # See every SQL query
      POSTGRESQL_LOG_MIN_DURATION_STATEMENT: 500         # Catch slow queries
      POSTGRESQL_LOG_LOCK_WAITS: 'on'                    # Debug deadlocks
    volumes:
      - polar-postgres-vol:/bitnami/postgresql
      - ./db/schema-postgres.sql:/docker-entrypoint-initdb.d/1-init.sql
    ports:
      - '${POSTGRES_PORT:-5432}:5432'
    networks:
      postgres:
        aliases:
          - 'postgres'
    restart: unless-stopped
    healthcheck:
      test: [ 'CMD-SHELL', 'pg_isready -U ${POLAR_POSTGRES_USER:-postgres} -d polar_db' ]
      start_period: 30s
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

networks:
  postgres:
    name: polar-postgres-nw
    external: true

volumes:
  polar-postgres-vol:
    driver: local